<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–å½¢æ—‹è½‰é‡ç–Šåˆ†æå™¨ (å¯¦æˆ°æ¨ç†ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #f0f2f5; --cell-size: 45px; --grid-gap: 4px;
            --highlight-100: #ff0000; --highlight-75: #ff6b6b; --highlight-50: #ffbaba; --highlight-25: #ffe3e3;
            --miss-color: #e0e0e0;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 0.9em; margin-bottom: 20px; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; font-size: 1.1em; background: #ddd; border: none; border-radius: 8px 8px 0 0; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: white; font-weight: bold; border-top: 3px solid #007bff; }
        .tab-content { display: none; width: 100%; max-width: 1100px; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .tab-content.active { display: flex; }

        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 340px; }

        .grid-container { display: grid; grid-template-columns: repeat(6, var(--cell-size)); grid-template-rows: repeat(6, var(--cell-size)); gap: var(--grid-gap); background-color: #333; padding: var(--grid-gap); border-radius: 4px; margin: 15px 0; }
        .cell { background-color: white; width: var(--cell-size); height: var(--cell-size); cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; user-select: none; }

        /* ç¶²æ ¼ç‹€æ…‹é¡è‰² */
        .cell[data-state="X"] { background-color: var(--miss-color); color: #888; }
        .cell[data-state="O"] { background-color: #444; color: white; }
        .cell[data-state="0"], .cell[data-state="1"], .cell[data-state="2"], .cell[data-state="3"] { background-color: #0056b3; color: white; }

        /* ç†±å€é¡è‰² */
        .heatmap-cell[data-prob="100"] { border: 3px solid darkred; background-color: var(--highlight-100); color: white; }
        .heatmap-cell[data-prob="high"] { background-color: var(--highlight-75); }
        .heatmap-cell[data-prob="med"] { background-color: var(--highlight-50); }
        .heatmap-cell[data-prob="low"] { background-color: var(--highlight-25); }

        .controls, .row-controls { display: flex; gap: 10px; width: 100%; align-items: center; flex-wrap: wrap; justify-content: center;}
        input[type="text"], textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}
        textarea { height: 120px; font-family: monospace; resize: vertical; width: 100%;}

        button { padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.danger { background-color: #dc3545; }

        .tool-btn { padding: 6px 12px; background: #e2e8f0; color: #333; border: 2px solid transparent; font-weight: bold; }
        .tool-btn.selected { border-color: #000; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
        .tool-btn[data-val="0"], .tool-btn[data-val="1"], .tool-btn[data-val="2"], .tool-btn[data-val="3"] { background: #cce5ff; color: #004085; }
        .tool-btn.selected[data-val="0"], .tool-btn.selected[data-val="1"], .tool-btn.selected[data-val="2"], .tool-btn.selected[data-val="3"] { background: #0056b3; color: white; border-color: #004085;}

        .info-box { padding: 12px; background: #e9ecef; border-radius: 4px; width: 100%; font-size: 0.95rem; box-sizing: border-box; text-align: left;}
        .possibility-list { font-size: 0.9em; color: #444; margin-top: 10px; max-height: 150px; overflow-y: auto; background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd; width: 100%; box-sizing: border-box;}
        .db-list { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
        .db-tag { background: #eee; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; }

    </style>
</head>
<body>

    <h1>åœ–å½¢æ¨ç†è¨ˆç®—æ©Ÿ</h1>
    <div class="subtitle">è¼¸å…¥ä»£ç¢¼ -> è¼‰å…¥åœ–å½¢ -> é»æ“Šæ ¼å­çµ¦äºˆæ¢ä»¶ -> å‹•æ…‹å‰”é™¤</div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('deduce')">1. å¯¦æˆ°æ¨ç†</button>
        <button class="tab-btn" onclick="switchTab('edit')">2. è³‡æ–™åº«å»ºæª”</button>
    </div>

    <div id="tab-deduce" class="tab-content active">
        <div class="panel">
            <h3>1. è¼‰å…¥ç›®æ¨™èˆ‡è¨­å®šæ¢ä»¶</h3>
            <div class="row-controls" style="margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                <input type="text" id="targetCode" placeholder="è¼¸å…¥åœ–å½¢ä»£ç¢¼ (å¦‚ 2222)" style="width: 150px;">
                <button onclick="startDeduction()">è¼‰å…¥ä¸¦é‡ç½®æ¨ç†</button>
            </div>

            <p style="font-size:0.85em; color:#666; margin:0 0 5px 0;">é¸æ“‡å·¥å…·å¾Œï¼Œé»æ“Šä¸‹æ–¹ç¶²æ ¼æ¨™è¨˜ä½ çœ‹åˆ°çš„çµæœï¼š</p>
            <div class="row-controls" id="deduceTools">
                <button class="tool-btn selected" data-val="?">æ¸…é™¤</button>
                <button class="tool-btn" data-val="X">ç„¡åœ–(X)</button>
                <button class="tool-btn" data-val="O">æœ‰åœ–(ç„¡æ–¹å‘)</button>
                <button class="tool-btn" data-val="0">ä¸Š(â†‘)</button>
                <button class="tool-btn" data-val="1">å³(â†’)</button>
                <button class="tool-btn" data-val="2">ä¸‹(â†“)</button>
                <button class="tool-btn" data-val="3">å·¦(â†)</button>
            </div>

            <div class="grid-container" id="deduceGrid"></div>
        </div>

        <div class="panel">
            <h3>2. æ©Ÿç‡ç†±å€ (å‹•æ…‹è¨ˆç®—)</h3>
            <div class="grid-container" id="heatmapGrid"></div>
            <div class="info-box" id="deduceInfo">è«‹å…ˆè¼¸å…¥ä»£ç¢¼ä¸¦è¼‰å…¥ã€‚</div>
            <div class="possibility-list" id="possibilityList"></div>
        </div>
    </div>

    <div id="tab-edit" class="tab-content">
        <div class="panel">
            <h3>ç¹ªè£½æ–°åœ–å½¢</h3>
            <div class="row-controls" id="editTools" style="margin-bottom: 10px;">
                <button class="tool-btn selected" data-val="?">æ©¡çš®æ“¦</button>
                <button class="tool-btn" data-val="0">ä¸Š(â†‘)</button>
                <button class="tool-btn" data-val="1">å³(â†’)</button>
                <button class="tool-btn" data-val="2">ä¸‹(â†“)</button>
                <button class="tool-btn" data-val="3">å·¦(â†)</button>
            </div>
            <div class="grid-container" id="editGrid"></div>
            <div class="row-controls">
                <input type="text" id="editCode" placeholder="åœ–å½¢ä»£ç¢¼ (å¦‚ 2222)" style="width: 150px;">
                <button onclick="saveShape()">å„²å­˜è‡³æ­¤ä»£ç¢¼</button>
                <button onclick="clearEditGrid()" class="secondary">æ¸…ç©ºç•«å¸ƒ</button>
            </div>
            <p style="font-size: 0.8em; color: #666; margin-top: 5px;">*åŒä¸€å€‹ä»£ç¢¼å¯ä»¥å„²å­˜å¤šæ¬¡ï¼Œæœƒè¦–ç‚ºè©²ä»£ç¢¼çš„å¤šç¨®å¯èƒ½åœ–å½¢ã€‚</p>
        </div>

        <div class="panel">
            <h3>è³‡æ–™åº«ç®¡ç†</h3>
            <div class="db-list" id="dbCodeList"></div>
            <hr style="width:100%; margin:15px 0; border:0; border-top:1px solid #ddd;">
            <p style="font-size: 0.85em; color: #666; margin: 0;">åŒ¯å…¥/åŒ¯å‡º JSON</p>
            <textarea id="dbTextarea"></textarea>
            <div class="row-controls" style="margin-top: 10px;">
                <button onclick="importJSON()">åŒ¯å…¥ JSON</button>
                <button onclick="exportJSON()" class="secondary">åŒ¯å‡º JSON</button>
                <button onclick="clearDB()" class="danger">æ¸…ç©ºè‡ªè¨‚åº«</button>
            </div>
        </div>
    </div>

    <script>
        // ================= æ ¸å¿ƒè³‡æ–™åº« =================
        // è³‡æ–™çµæ§‹: { "ä»£ç¢¼": [ å½¢ç‹€1, å½¢ç‹€2... ] }
        // å½¢ç‹€: [ {x, y, d}, ... ] (d: 0=ä¸Š, 1=å³, 2=ä¸‹, 3=å·¦, O=ç„¡æ–¹å‘)
        const PERMANENT_DB = {
            "2222": [
                [
                    {x:1, y:1, d:0}, {x:2, y:1, d:0},
                    {x:5, y:2, d:0}, {x:6, y:2, d:0},
                    {x:1, y:5, d:0}, {x:2, y:5, d:0},
                    {x:4, y:4, d:1}, {x:4, y:5, d:1}
                ]
            ],
            "2242": [
                [
                    {x:1, y:1, d:2}, {x:2, y:1, d:2},
                    {x:1, y:4, d:3}, {x:1, y:5, d:3},
                    {x:2, y:3, d:1}, {x:2, y:4, d:1}, {x:3, y:3, d:1}, {x:3, y:4, d:1},
                    {x:5, y:2, d:1}, {x:5, y:3, d:1}
                ]
            ]
        };

        let localDB = JSON.parse(localStorage.getItem('advancedShapeDB')) || {};
        const GRID_SIZE = 6;
        const DIR_CHARS = { '?': '', 'X': 'X', 'O': 'O', '0': 'â†‘', '1': 'â†’', '2': 'â†“', '3': 'â†' };

        // å–å¾—åˆä½µè³‡æ–™åº«
        function getCombinedDB() {
            const combined = JSON.parse(JSON.stringify(PERMANENT_DB)); // Deep copy
            for (let code in localDB) {
                if (!combined[code]) combined[code] = [];
                combined[code] = combined[code].concat(localDB[code]);
            }
            return combined;
        }

        // ================= åˆå§‹åŒ–èˆ‡ UI =================
        let currentDeduceTool = '?';
        let currentEditTool = '?';
        let activeStates = []; // ç•¶å‰ç¬¦åˆæ¢ä»¶çš„æ‰€æœ‰æ—‹è½‰åœ–å½¢

        function init() {
            createGrid('deduceGrid', 'deduce');
            createGrid('heatmapGrid', 'heatmap');
            createGrid('editGrid', 'edit');

            setupTools('deduceTools', (val) => currentDeduceTool = val);
            setupTools('editTools', (val) => currentEditTool = val);
            updateDBListUI();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        function createGrid(elementId, mode) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            for (let y = GRID_SIZE; y >= 1; y--) {
                for (let x = 1; x <= GRID_SIZE; x++) {
                    const div = document.createElement('div');
                    div.className = `cell ${mode}-cell`;
                    div.dataset.x = x; div.dataset.y = y;
                    div.dataset.state = '?';

                    if (mode === 'deduce') {
                        div.onclick = () => {
                            div.dataset.state = currentDeduceTool;
                            div.innerHTML = DIR_CHARS[currentDeduceTool];
                            runFilter();
                        };
                    } else if (mode === 'edit') {
                        div.onclick = () => {
                            div.dataset.state = currentEditTool;
                            div.innerHTML = DIR_CHARS[currentEditTool];
                        };
                    }
                    container.appendChild(div);
                }
            }
        }

        function setupTools(containerId, callback) {
            document.querySelectorAll(`#${containerId} .tool-btn`).forEach(btn => {
                btn.onclick = (e) => {
                    document.querySelectorAll(`#${containerId} .tool-btn`).forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                    callback(e.target.dataset.val);
                };
            });
        }

        // ================= æ—‹è½‰èˆ‡æ•¸å­¸é‚è¼¯ =================
        // æ—‹è½‰é» 90 åº¦é †æ™‚é‡ times æ¬¡
        function rotatePoint(x, y, dir, times) {
            let nx = x, ny = y, ndir = dir;
            for(let i=0; i<times; i++) {
                let tempX = nx;
                nx = ny;
                ny = GRID_SIZE + 1 - tempX;
                if(ndir !== 'O' && ndir !== '?') {
                    ndir = (parseInt(ndir) + 1) % 4;
                    ndir = ndir.toString();
                }
            }
            return { x: nx, y: ny, d: ndir };
        }

        // ================= å¯¦æˆ°æ¨ç†é‚è¼¯ =================
        function startDeduction() {
            const code = document.getElementById('targetCode').value.trim();
            const db = getCombinedDB();

            if (!code || !db[code]) {
                alert(`æ‰¾ä¸åˆ°åœ–å½¢ä»£ç¢¼: ${code}`);
                return;
            }

            // æ¸…ç©ºæ¨ç†ç¶²æ ¼
            document.querySelectorAll('.deduce-cell').forEach(c => { c.dataset.state = '?'; c.innerHTML = ''; });

            // ç”¢ç”Ÿè©²ä»£ç¢¼æ‰€æœ‰åœ–å½¢çš„ 4 ç¨®è§’åº¦
            activeStates = [];
            const shapes = db[code];
            shapes.forEach((shape, shapeIdx) => {
                for (let rot = 0; rot < 4; rot++) {
                    let rotatedPoints = shape.map(pt => rotatePoint(pt.x, pt.y, pt.d, rot));
                    activeStates.push({
                        name: `åœ–å½¢${shapeIdx + 1} (${rot * 90}åº¦)`,
                        points: rotatedPoints
                    });
                }
            });

            runFilter();
        }

        function runFilter() {
            if (activeStates.length === 0) {
                document.getElementById('deduceInfo').innerHTML = "è«‹å…ˆè¼‰å…¥åœ–å½¢ä»£ç¢¼ã€‚";
                return;
            }

            // å–å¾—ç¶²æ ¼ä¸Šçš„æ¢ä»¶
            let constraints = [];
            document.querySelectorAll('.deduce-cell').forEach(cell => {
                const state = cell.dataset.state;
                if (state !== '?') {
                    constraints.push({ x: parseInt(cell.dataset.x), y: parseInt(cell.dataset.y), reqState: state });
                }
            });

            // ç¯©é¸ç¬¦åˆæ¢ä»¶çš„ç‹€æ…‹
            let validStates = activeStates.filter(state => {
                let map = {};
                state.points.forEach(p => { map[`${p.x},${p.y}`] = p; });

                for (let c of constraints) {
                    const pt = map[`${c.x},${c.y}`];
                    if (c.reqState === 'X') {
                        if (pt) return false; // è¦ç©ºæ ¼ä½†æœ‰æ±è¥¿
                    } else if (c.reqState === 'O') {
                        if (!pt) return false; // è¦æ±è¥¿ä½†æ²’æœ‰
                    } else { // 0, 1, 2, 3 (æ–¹å‘)
                        if (!pt || pt.d !== c.reqState) return false; // æ–¹å‘ä¸å°æˆ–æ²’æ±è¥¿
                    }
                }
                return true;
            });

            updateHeatmap(validStates);
        }

        function updateHeatmap(validStates) {
            const heatmapCells = document.querySelectorAll('.heatmap-cell');
            const info = document.getElementById('deduceInfo');
            const list = document.getElementById('possibilityList');

            heatmapCells.forEach(c => { c.dataset.prob = ""; c.innerHTML = ""; });

            if (validStates.length === 0) {
                info.innerHTML = "<span style='color:red; font-weight:bold;'>æ¢ä»¶è¡çªï¼æ²’æœ‰ç¬¦åˆçš„åœ–å½¢ï¼Œè«‹æª¢æŸ¥æ¨™è¨˜æ˜¯å¦é»éŒ¯äº†ã€‚</span>";
                list.innerHTML = "";
                return;
            }

            // è¨ˆç®—é »ç‡
            let freq = {};
            validStates.forEach(state => {
                state.points.forEach(p => {
                    const key = `${p.x},${p.y}`;
                    freq[key] = (freq[key] || 0) + 1;
                });
            });

            const total = validStates.length;
            let mustHitCoords = [];

            heatmapCells.forEach(cell => {
                const key = `${cell.dataset.x},${cell.dataset.y}`;
                const count = freq[key] || 0;

                if (count > 0) {
                    const percent = Math.round((count / total) * 100);
                    cell.innerHTML = percent === 100 ? 'å¿…' : `${percent}%`;

                    if (percent === 100) {
                        cell.dataset.prob = "100";
                        mustHitCoords.push(`(${cell.dataset.x},${cell.dataset.y})`);
                    } else if (percent >= 75) cell.dataset.prob = "high";
                    else if (percent >= 50) cell.dataset.prob = "med";
                    else cell.dataset.prob = "low";
                }
            });

            let msg = `å‰©é¤˜å¯èƒ½çµ„åˆï¼š <strong>${total}</strong> ç¨®ã€‚<br>`;
            if (mustHitCoords.length > 0) {
                msg += `<span style="color:darkred; font-weight:bold;">ğŸ‘‰ ä¸‹ä¸€æ­¥å»ºè­°é»æ“Šå¿…ä¸­æ ¼å­ï¼š${mustHitCoords.join(', ')}</span>`;
            } else {
                msg += `ç›®å‰ç„¡ 100% é‡åˆçš„æ ¼å­ï¼Œè«‹é»æ“Šæ©Ÿç‡æœ€é«˜çš„æ ¼å­ã€‚`;
            }
            info.innerHTML = msg;

            let stateStrs = validStates.map(s => s.name);
            list.innerHTML = `<strong>å‰©é¤˜å¯èƒ½ï¼š</strong><br>` + stateStrs.join('<br>');
        }

        // ================= è³‡æ–™åº«å»ºæª”é‚è¼¯ =================
        function saveShape() {
            const code = document.getElementById('editCode').value.trim();
            if (!code) return alert("è«‹è¼¸å…¥ä»£ç¢¼ï¼");

            let points = [];
            document.querySelectorAll('.edit-cell').forEach(cell => {
                const state = cell.dataset.state;
                if (state !== '?' && state !== 'X') {
                    points.push({ x: parseInt(cell.dataset.x), y: parseInt(cell.dataset.y), d: state });
                }
            });

            if(points.length === 0) return alert("ç•«å¸ƒæ˜¯ç©ºçš„ï¼");

            if (!localDB[code]) localDB[code] = [];
            localDB[code].push(points);

            localStorage.setItem('advancedShapeDB', JSON.stringify(localDB));
            updateDBListUI();
            clearEditGrid();
            alert(`å·²æ–°å¢ä¸€ç¨®åœ–å½¢è‡³ä»£ç¢¼ [${code}]ï¼`);
        }

        function clearEditGrid() {
            document.querySelectorAll('.edit-cell').forEach(c => { c.dataset.state = '?'; c.innerHTML = ''; });
        }

        function updateDBListUI() {
            const listEl = document.getElementById('dbCodeList');
            listEl.innerHTML = '';
            const db = getCombinedDB();

            Object.keys(db).sort().forEach(code => {
                const tag = document.createElement('div');
                tag.className = 'db-tag';
                const count = db[code].length;
                const isPerm = PERMANENT_DB.hasOwnProperty(code);
                tag.textContent = `${code} (${count}ç¨®åœ–å½¢) ${isPerm ? "ğŸ”’" : ""}`;
                listEl.appendChild(tag);
            });
        }

        function exportJSON() {
            document.getElementById('dbTextarea').value = JSON.stringify(getCombinedDB(), null, 2);
        }

        function importJSON() {
            try {
                const data = JSON.parse(document.getElementById('dbTextarea').value);
                localDB = Object.assign(localDB, data);
                localStorage.setItem('advancedShapeDB', JSON.stringify(localDB));
                updateDBListUI();
                alert("åŒ¯å…¥æˆåŠŸï¼");
            } catch(e) { alert("JSON æ ¼å¼éŒ¯èª¤ï¼"); }
        }

        function clearDB() {
            if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‚¨è‡ªå·±å»ºç«‹çš„è³‡æ–™åº«å—ï¼Ÿ(å¸¶æœ‰ ğŸ”’ çš„å…§å»ºè³‡æ–™ä¸æœƒè¢«åˆªé™¤)")) {
                localDB = {};
                localStorage.setItem('advancedShapeDB', JSON.stringify(localDB));
                updateDBListUI();
            }
        }

        init();
    </script>
</body>
</html>
